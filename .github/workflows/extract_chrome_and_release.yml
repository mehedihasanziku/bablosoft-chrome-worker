name: Extract Full Chrome Folder and Upload Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  extract-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Set version info
        id: vars
        run: |
          echo "version=28.8.1" >> $GITHUB_OUTPUT
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Download FastExecuteScript ZIP
        run: |
          curl -L -o FastExecuteScript.zip "http://downloads.bablosoft.com/distr/FastExecuteScriptProtected64/${{ steps.vars.outputs.version }}/FastExecuteScriptProtected.x64.zip"

      - name: Get highest Worker.xx folder in ZIP
        id: get_worker
        run: |
          folders=$(unzip -Z1 FastExecuteScript.zip | grep -oE '^Worker\.[0-9]+/' | sort -Vr | uniq)
          highest=$(echo "$folders" | head -n1 | sed 's:/$::')
          echo "worker=$highest" >> $GITHUB_OUTPUT
          echo "Found highest worker: $highest"

      - name: Extract full chrome folder only
        run: |
          # Extract only chrome files to extracted_chrome preserving structure but removing Worker.xx prefix
          mkdir extracted_chrome
          # List all files under Worker.xx/chrome/
          files=$(unzip -Z1 FastExecuteScript.zip | grep "^${{ steps.get_worker.outputs.worker }}/chrome/")
          # Extract each file, stripping the Worker.xx/ prefix to place directly under extracted_chrome/
          for file in $files; do
            target_file=${file#${{ steps.get_worker.outputs.worker }}/}
            unzip -j -q FastExecuteScript.zip "$file" -d "extracted_chrome/$(dirname "$target_file")"
          done

      - name: Zip extracted chrome folder (without parent Worker.xx)
        run: |
          cd extracted_chrome
          zip -r ../chrome_${{ steps.vars.outputs.version }}_${{ steps.vars.outputs.date }}.zip chrome

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Chrome Build ${{ steps.vars.outputs.version }} - ${{ steps.vars.outputs.date }}"
          tag_name: "chrome-${{ steps.vars.outputs.version }}-${{ steps.vars.outputs.date }}"
          files: chrome_${{ steps.vars.outputs.version }}_${{ steps.vars.outputs.date }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
